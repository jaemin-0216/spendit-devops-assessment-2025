name: CI/CD for Receipt API (AWS Lambda Container Image)

on:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  lambda-deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-northeast-2
      ECR_REPO: receipt-api
      LAMBDA_FUNCTION_NAME: receipt-api-lambda
      IMAGE_TAG: ${{ github.sha }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
    # -----------------------------------------------------
    # 1) Checkout
    # -----------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # -----------------------------------------------------
    # 2) Buildx ì„¸íŒ…
    # -----------------------------------------------------
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # -----------------------------------------------------
    # 3) Docker ì´ë¯¸ì§€ ë¹Œë“œ
    # -----------------------------------------------------
    - name: Build Docker image
      id: build_image
      run: 
        IMAGE_URI=${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG}
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
        echo "IMAGE_URI=$IMAGE_URI"
        docker build -t $IMAGE_URI .

    # -----------------------------------------------------
    # 4) í…ŒìŠ¤íŠ¸
    # -----------------------------------------------------
    - name: Run container for test
      id: container_test
      run: |
        echo "ğŸ³ Running container for test..."
        docker run -d --name receipt-api -p 8000:8000 $IMAGE_URI

    - name: Run test-api.sh
      id: test_api
      run: |
        echo "Running test-api.sh..."
        chmod +x test-api.sh
        ./test-api.sh

    - name: Cleanup container
      if: always()
      run: |
        echo "ë¹Œë“œ ëœ docker ì´ë¯¸ì§€ë¥¼ ì‚­ì œ í•©ë‹ˆë‹¤...."
        docker logs receipt-api || true
        docker rm -f receipt-api || true

    # -----------------------------------------------------
    # 5) AWS Credentials (OIDC)
    # -----------------------------------------------------
    - name: Configure AWS Credentials (OIDC)
      id: aws_creds
      run: echo "AWS Credentials configured via OIDC"
      # uses: aws-actions/configure-aws-credentials@v4
      # with:
      #   role-to-assume: arn:aws:iam::<AWS_ACCOUNT_ID>:role/<GITHUB_DEPLOY_ROLE>
      #   aws-region: ap-northeast-2

    # -----------------------------------------------------
    # 6) ECR push
    # -----------------------------------------------------
    - name: Login to ECR
      id: ecr_login
      run: |
        aws ecr get-login-password --region $AWS_REGION \
        | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

    - name: Ensure ECR repo exists
      id: ecr_check
      run: |
        aws ecr describe-repositories --repository-names $ECR_REPO || \
        aws ecr create-repository --repository-name $ECR_REPO

    - name: Push image to ECR
      id: ecr_push
      run: docker push $IMAGE_URI

    # -----------------------------------------------------
    # 7) Lambda ì—…ë°ì´íŠ¸ (ì‹œë®¬ë ˆì´ì…˜)
    # -----------------------------------------------------
    - name: Deploy to Lambda (Simulated)
      id: lambda_deploy
      run: |
        echo "ğŸš€ Deploy Lambda (Simulated)"
        echo "Function: $LAMBDA_FUNCTION_NAME"
        echo "Image URI: $IMAGE_URI"

        # ì‹¤ì œ ë°°í¬ ì˜ˆì‹œ:
        # aws lambda update-function-code \
        #   --function-name $LAMBDA_FUNCTION_NAME \
        #   --image-uri $IMAGE_URI

    # -----------------------------------------------------
    # 8) ğŸ”¥ ì‹¤íŒ¨ ì‹œ ìë™ Rollback ì‹¤í–‰
    # -----------------------------------------------------
    - name: Rollback on failure
      if: failure()
      run: 
        echo "â—â— Deployment failed â†’ Starting rollback..."
        echo "-----------------------------------------"
        echo "ğŸ“ FAILED STEP LOGS:"
        echo "-----------------------------------------"

        echo "[Build Image Log]"
        echo "${{ steps.build_image.outcome }}"

        echo "[Test Container Log]"
        echo "${{ steps.container_test.outcome }}"

        echo "[test-api.sh Log]"
        echo "${{ steps.test_api.outcome }}"

        echo "[ECR Push Log]"
        echo "${{ steps.ecr_push.outcome }}"

        echo "[Lambda Deploy Log]"
        echo "${{ steps.lambda_deploy.outcome }}"

        echo "-----------------------------------------"
        echo "â¬…ï¸ Lambda Rollback (Simulated)"
        echo "ì´ì „ ì•ˆì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•œë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤."
        echo "Rollback completed (Simulated)"
        # ì‹¤ì œ Lambda ë¡¤ë°± ëª…ë ¹:
        # aws lambda update-function-code \
        #   --function-name $LAMBDA_FUNCTION_NAME \
        #   --image-uri <PREVIOUS_IMAGE_URI>

        

    # -----------------------------------------------------
    # 9) ì™„ë£Œ ë¡œê·¸
    # -----------------------------------------------------
    - name: Pipeline Completed
      if: success()
      run: echo "ğŸ‰ Deployment Succeeded"
